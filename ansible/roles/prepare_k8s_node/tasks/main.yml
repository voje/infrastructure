---
# tasks file for kubeadmin_install
- name: Load br_netfilter module
  lineinfile:
    create: true
    path: /etc/modules-load.d/k8s.conf
    line: "br_netfilter"

- name: modprobe br_netfilter
  modprobe:
    name: br_netfilter
    state: present

- name: Enable processing of IP packets traversing bridges by iptables
  sysctl:
    name: "{{ item }}"
    value: 1
    state: present
    reload: true
    sysctl_set: true
  with_items:
  - net.bridge.bridge-nf-call-ip6tables
  - net.bridge.bridge-nf-call-iptables

- name: Save facts to file locally
  copy:
    content: "{{ vars | to_nice_json }}"
    dest: "/tmp/ansible_vars.json"
  delegate_to: localhost

- name: Install apt packages
  apt:
    update_cache: true
    pkg:
    - apt-transport-https
    - ca-certificates

- name: Get kubernetes gpg key
  get_url:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    dest: /usr/share/keyrings/kubernetes-archive-keyring.gpg 

- name: Add k8s repo
  lineinfile:
    create: true
    line: "deb [signed-by=/usr/share/keyrings/kubernetes-archive-keyring.gpg] https://apt.kubernetes.io/ kubernetes-xenial main"
    path: "/etc/apt/sources.list.d/kubernetes.list"

- name: Install apt packages
  apt:
    update_cache: true
    pkg: "{{ kube_packages }}"
  
- name: Hold packages
  dpkg_selections:
    name: "{{ item }}"
    selection: hold
  with_items: "{{ kube_packages }}"

